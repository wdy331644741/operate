{include file="header.html"}
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <div class="top-title">
        <h2 class="sub-header">用户银行卡信息</h2>
    </div>
    <div style="clear:both"></div>
    {include file="search.html"}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <th>id</th>
                <th >用户id</th>
                <th >银行名字</th>
                <th >银行code</th>
                <th >银行卡号</th>
                <th >来源渠道</th>
                <th >用户真实姓名</th>
                <th >银行预留手机号</th>
                <th >绑卡状态</th>
            </tr>
            </thead>
            <tbody>
            {if $lists}
            {foreach $lists as $item}
            <tr>
                <td>{$item.id}</td>
                <td>{$item.user_id}</td>
                <td>{$item.bankname}</td>
                <td>{$item.bankcode}</td>
                <td>{$item.cardno}</td>
                <td>{$item.channel}</td>
                <td>{$item.realname}</td>
                <td>{$item.phone}</td>
                <td>
                    {if $item.status==1}
                    <a href="javascript:void(0);" data="{$item.channel}"  class="btn btn-danger btn-xs bankcardstatus">解除绑定</a>
                    <a href="javascript:void(0);" data="{$item.cardno}"  class="btn btn-danger btn-xs resetting_card">删除</a>
                    {else if $item.status==0}
                       未绑定
                    {else if $item.status==2}
                       已解除绑定
                    {/if}
                   <!-- <a href="javascript:void(0);" data="{$item.cardno}" data-id="{$item.id}" data-toggle="modal" data-target="#myModal1{$item.id}" class="btn btn-danger btn-xs">修改卡号</a>
               --> </td>
            </tr>
            <!--展示拉黑原因-->
            <tr>
                <td>
                    <div class="modal fade" id="myModal{$item.id}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                    <h4 class="modal-title" id="myModalLabel1">银行卡拉黑</h4>
                                </div>
                                <div class="modal-body">
                                <table class="table table-striped table-hover" id="item{$item.id}" >
                                    <thead>
                                        <tr>
                                            <th>id</th>
                                            <th>银行卡号</th>
                                            <th>拉黑原因</th>
                                            <th>创建时间</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {if $item.black_info}
                                    {foreach $item.black_info as $black}
                                        <tr>
                                            <td>{$black.id}</td>
                                            <td>{$black.card_no}</td>
                                            <td>{$black.message}</td>
                                            <td>{$black.create_time}</td>
                                        </tr>
                                    {/foreach}
                                    {/if}
                                    </tbody>
                                </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            <!--结束-->
            <!--修改银行卡号-->
            <tr>
                <td>
                    <div class="modal fade" id="myModal1{$item.id}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                        <form class="form-inline" method="post" action="?c=user&a=edit_card" >
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                    <h4 class="modal-title" id="myModalLabel2">银行卡号修改</h4>
                                </div>
                                <div class="modal-body">
                                    <br/><br/>
                                    <div class="form-group">
                                        <label ><span class="name_span">银行名字:</span></label>
                                        <input  type="text" name="bank_name" value="" />
                                    </div>
                                    <br/><br/>
                                    <div class="form-group">
                                        <label ><span class="name_span">银行code:</span></label>
                                        <input  type="text" name="bank_code" value="" />
                                    </div>
                                    <div class="form-group">
                                        <label ><span class="name_span">新卡号:</span></label>
                                        <input style="width: 300px;height: 30px;" type="text" name="content" value="" />
                                    </div>
                                    <br/><br/>
                                    <input type="hidden" name="id" value="{$item.id}" id="bank_id">
                                    <input type="hidden" name="old_card" id="old_card" value="{$item.cardno}">
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-default">提交</button>
                                </div>
                            </div>
                        </div>
                        </form>
                    </div>
                </td>
            </tr>
            <!--修改银行卡号结束-->
            {/foreach}
            {else}
            <tr>
                <td colspan="7">没有数据</td>
            </tr>
            {/if}
            </tbody>
        </table>
    </div>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <form class="form-inline" method="post" action="?c=user&a=black_card">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="myModalLabel">银行卡拉黑</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label ><span class="name_span">拉黑原因</span></label>
                            <textarea rows="3" cols="40"  name="content" value=""></textarea>
                        </div>
                        <input type="hidden" name="id" value="" id="id">
                        <input type="hidden" name="card" id="card" value="">
                        <input type="hidden" name="type" id="blacktype" value="">
                    </div>
                    <div class="modal-footer">
                        <button type="submit"  class="btn btn-default" >提交</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    {include file="footer.html"}
    <script>
        //用户解卡操作
        $('.bankcardstatus').click(function(){
            var id = $(this).parent().parent().find('td:first').html();
            var channel = $(this).attr('data');
            if(channel=='YEEPAY')
            {
                if (!confirm("当前是易宝渠道的解卡操作,请确定易宝已解除该卡绑定！")) {
                    return false;
                }
            }else
            {
                if (!confirm("确认要进行解卡操作嘛？")) {
                    return false;
                }
            }
            $.ajax({
                url:'?c=user&a=solutionCard',
                method:'post',
                data:{
                    'id':id
                },
                dataType:'json',
                success:function(data) {
                    if(data.error == 100)
                    {
                        throwExc(data.msg);
                        return false;
                    }else if(data.error == 200)
                    {
                        showSucc(data.msg);
                        setTimeout("load()",1000);
                    }
                },
            })
        });
        //加入黑名单/解除黑名单
        $(".black_card").click(function(){
            var type = $(this).attr('type');
            var id = $(this).parent().parent().find('td:first').html();
            var card = $(this).attr('data');
            if(type==2){
                $("#id").val(id);
                $("#card").val(card);
                $("#blacktype").val(type);
            }else if(type ==1){
                if (!confirm("你确定将该卡从黑名单中去除吗？请先查看拉黑原因!")) {
                    return false;
                }
                $.ajax({
                    url:'?c=user&a=black_card',
                    method:'post',
                    data:{
                        'id':id,
                        'card':card,
                        'type':1
                    },
                    dataType:'json',
                    success:function(data) {
                        if(data.error == 100)
                        {
                            throwExc(data.msg);
                            return false;
                        }else if(data.error == 200)
                        {
                            showSucc(data.msg);
                            setTimeout("load()",1000);
                        }
                    },
                })
            }

        })
        //重置银行卡
        $(".resetting_card").click(function(){
            var id = $(this).parent().parent().find('td:first').html();
            var card = $(this).attr('data');
            if (!confirm("重置该卡,将该卡重置为未绑卡状态")) {
                return false;
            }
            $.ajax({
                url:'?c=user&a=resetting_card',
                method:'post',
                data:{
                    'id':id,
                    'card':card
                },
                dataType:'json',
                success:function(data) {
                    if(data.error == 100)
                    {
                        throwExc(data.msg);
                        return false;
                    }else if(data.error == 200)
                    {
                        showSucc(data.msg);
                        setTimeout("load()",1000);
                    }
                },
            })
        });
        function load(){
            window.location.href="?c=user&a=banklist";
        };
    </script>